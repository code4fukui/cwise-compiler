function r(r,e,s){var a,n,o=r.length,t=e.arrayArgs.length,i=e.indexArgs.length>0,h=[],p=[],c=0,u=0;for(a=0;a<o;++a)p.push(["i",a,"=0"].join(""));for(n=0;n<t;++n)for(a=0;a<o;++a)u=c,c=r[a],0===a?p.push(["d",n,"s",a,"=t",n,"p",c].join("")):p.push(["d",n,"s",a,"=(t",n,"p",c,"-s",u,"*t",n,"p",u,")"].join(""));for(p.length>0&&h.push("var "+p.join(",")),a=o-1;a>=0;--a)c=r[a],h.push(["for(i",a,"=0;i",a,"<s",c,";++i",a,"){"].join(""));for(h.push(s),a=0;a<o;++a){for(u=c,c=r[a],n=0;n<t;++n)h.push(["p",n,"+=d",n,"s",a].join(""));i&&(a>0&&h.push(["index[",u,"]-=s",u].join("")),h.push(["++index[",c,"]"].join(""))),h.push("}")}return h.join("\n")}function e(r,e,s){for(var a=r.body,n=[],o=[],t=0;t<r.args.length;++t){var i=r.args[t];if(!(i.count<=0)){var h=new RegExp(i.name,"g"),p="",c=e.arrayArgs.indexOf(t);switch(e.argTypes[t]){case"offset":var u=e.offsetArgIndex.indexOf(t);c=e.offsetArgs[u].array,p="+q"+u;case"array":p="p"+c+p;var l="l"+t,g="a"+c;if(0===e.arrayBlockIndices[c])1===i.count?"generic"===s[c]?i.lvalue?(n.push(["var ",l,"=",g,".get(",p,")"].join("")),a=a.replace(h,l),o.push([g,".set(",p,",",l,")"].join(""))):a=a.replace(h,[g,".get(",p,")"].join("")):a=a.replace(h,[g,"[",p,"]"].join("")):"generic"===s[c]?(n.push(["var ",l,"=",g,".get(",p,")"].join("")),a=a.replace(h,l),i.lvalue&&o.push([g,".set(",p,",",l,")"].join(""))):(n.push(["var ",l,"=",g,"[",p,"]"].join("")),a=a.replace(h,l),i.lvalue&&o.push([g,"[",p,"]=",l].join("")));else{for(var f=[i.name],y=[p],d=0;d<Math.abs(e.arrayBlockIndices[c]);d++)f.push("\\s*\\[([^\\]]+)\\]"),y.push("$"+(d+1)+"*t"+c+"b"+d);if(h=new RegExp(f.join(""),"g"),p=y.join("+"),"generic"===s[c])throw new Error("cwise: Generic arrays not supported in combination with blocks!");a=a.replace(h,[g,"[",p,"]"].join(""))}break;case"scalar":a=a.replace(h,"Y"+e.scalarArgs.indexOf(t));break;case"index":a=a.replace(h,"index");break;case"shape":a=a.replace(h,"shape")}}}return[n.join("\n"),a,o.join("\n")].join("\n").trim()}function s(r){for(var e=new Array(r.length),s=!0,a=0;a<r.length;++a){var n=r[a],o=n.match(/\d+/);o=o?o[0]:"",0===n.charAt(0)?e[a]="u"+n.charAt(1)+o:e[a]=n.charAt(0)+o,a>0&&(s=s&&e[a]===e[a-1])}return s?e[0]:e.join("")}function a(a,n){for(var o=n[1].length-Math.abs(a.arrayBlockIndices[0])|0,t=new Array(a.arrayArgs.length),i=new Array(a.arrayArgs.length),h=0;h<a.arrayArgs.length;++h)i[h]=n[2*h],t[h]=n[2*h+1];var p=[],c=[],u=[],l=[],g=[];for(h=0;h<a.arrayArgs.length;++h){a.arrayBlockIndices[h]<0?(u.push(0),l.push(o),p.push(o),c.push(o+a.arrayBlockIndices[h])):(u.push(a.arrayBlockIndices[h]),l.push(a.arrayBlockIndices[h]+o),p.push(0),c.push(a.arrayBlockIndices[h]));for(var f=[],y=0;y<t[h].length;y++)u[h]<=t[h][y]&&t[h][y]<l[h]&&f.push(t[h][y]-u[h]);g.push(f)}var d=["SS"],j=["'use strict'"],w=[];for(y=0;y<o;++y)w.push(["s",y,"=SS[",y,"]"].join(""));for(h=0;h<a.arrayArgs.length;++h){d.push("a"+h),d.push("t"+h),d.push("p"+h);for(y=0;y<o;++y)w.push(["t",h,"p",y,"=t",h,"[",u[h]+y,"]"].join(""));for(y=0;y<Math.abs(a.arrayBlockIndices[h]);++y)w.push(["t",h,"b",y,"=t",h,"[",p[h]+y,"]"].join(""))}for(h=0;h<a.scalarArgs.length;++h)d.push("Y"+h);if(a.shapeArgs.length>0&&w.push("shape=SS.slice(0)"),a.indexArgs.length>0){var A=new Array(o);for(h=0;h<o;++h)A[h]="0";w.push(["index=[",A.join(","),"]"].join(""))}for(h=0;h<a.offsetArgs.length;++h){var b=a.offsetArgs[h],v=[];for(y=0;y<b.offset.length;++y)0!==b.offset[y]&&(1===b.offset[y]?v.push(["t",b.array,"p",y].join("")):v.push([b.offset[y],"*t",b.array,"p",y].join("")));0===v.length?w.push("q"+h+"=0"):w.push(["q",h,"=",v.join("+")].join(""))}var k,m,x,I=0===(k=[].concat(a.pre.thisVars).concat(a.body.thisVars).concat(a.post.thisVars)).length?k:m?(x||k.sort(m),function(r,e){for(var s=1,a=r.length,n=r[0],o=r[0],t=1;t<a;++t)if(o=n,e(n=r[t],o)){if(t===s){s++;continue}r[s++]=n}return r.length=s,r}(k,m)):(x||k.sort(),function(r){for(var e=1,s=r.length,a=r[0],n=r[0],o=1;o<s;++o)if(n=a,(a=r[o])!==n){if(o===e){e++;continue}r[e++]=a}return r.length=e,r}(k));(w=w.concat(I)).length>0&&j.push("var "+w.join(","));for(h=0;h<a.arrayArgs.length;++h)j.push("p"+h+"|=0");a.pre.body.length>3&&j.push(e(a.pre,a,i));var E=e(a.body,a,i),B=function(r){for(var e=0,s=r[0].length;e<s;){for(var a=1;a<r.length;++a)if(r[a][e]!==r[0][e])return e;++e}return e}(g);B<o?j.push(function(e,s,a,n){for(var o=s.length,t=a.arrayArgs.length,i=a.blockSize,h=a.indexArgs.length>0,p=[],c=0;c<t;++c)p.push(["var offset",c,"=p",c].join(""));for(c=e;c<o;++c)p.push(["for(var j"+c+"=SS[",s[c],"]|0;j",c,">0;){"].join("")),p.push(["if(j",c,"<",i,"){"].join("")),p.push(["s",s[c],"=j",c].join("")),p.push(["j",c,"=0"].join("")),p.push(["}else{s",s[c],"=",i].join("")),p.push(["j",c,"-=",i,"}"].join("")),h&&p.push(["index[",s[c],"]=j",c].join(""));for(c=0;c<t;++c){for(var u=["offset"+c],l=e;l<o;++l)u.push(["j",l,"*t",c,"p",s[l]].join(""));p.push(["p",c,"=(",u.join("+"),")"].join(""))}for(p.push(r(s,a,n)),c=e;c<o;++c)p.push("}");return p.join("\n")}(B,g[0],a,E)):j.push(r(g[0],a,E)),a.post.body.length>3&&j.push(e(a.post,a,i)),a.debug&&console.log("-----Generated cwise routine for ",n,":\n"+j.join("\n")+"\n----------");var S=[a.funcName||"unnamed","_cwise_loop_",t[0].join("s"),"m",B,s(i)].join("");return new Function(["function ",S,"(",d.join(","),"){",j.join("\n"),"} return ",S].join(""))()}function n(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function o(r){var e=new n;e.pre=r.pre,e.body=r.body,e.post=r.post;var s=r.args.slice(0);e.argTypes=s;for(var o=0;o<s.length;++o){var t=s[o];if("array"===t||"object"==typeof t&&t.blockIndices){if(e.argTypes[o]="array",e.arrayArgs.push(o),e.arrayBlockIndices.push(t.blockIndices?t.blockIndices:0),e.shimArgs.push("array"+o),o<e.pre.args.length&&e.pre.args[o].count>0)throw new Error("cwise: pre() block may not reference array args");if(o<e.post.args.length&&e.post.args[o].count>0)throw new Error("cwise: post() block may not reference array args")}else if("scalar"===t)e.scalarArgs.push(o),e.shimArgs.push("scalar"+o);else if("index"===t){if(e.indexArgs.push(o),o<e.pre.args.length&&e.pre.args[o].count>0)throw new Error("cwise: pre() block may not reference array index");if(o<e.body.args.length&&e.body.args[o].lvalue)throw new Error("cwise: body() block may not write to array index");if(o<e.post.args.length&&e.post.args[o].count>0)throw new Error("cwise: post() block may not reference array index")}else if("shape"===t){if(e.shapeArgs.push(o),o<e.pre.args.length&&e.pre.args[o].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(o<e.body.args.length&&e.body.args[o].lvalue)throw new Error("cwise: body() block may not write to array shape");if(o<e.post.args.length&&e.post.args[o].lvalue)throw new Error("cwise: post() block may not write to array shape")}else{if("object"!=typeof t||!t.offset)throw new Error("cwise: Unknown argument type "+s[o]);e.argTypes[o]="offset",e.offsetArgs.push({array:t.array,offset:t.offset}),e.offsetArgIndex.push(o)}}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>s.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>s.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>s.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!r.printCode||!!r.debug,e.funcName=r.funcName||"cwise",e.blockSize=r.blockSize||64,function(r){var e=["'use strict'","var CACHED={}"],s=[],n=r.funcName+"_cwise_thunk";e.push(["return function ",n,"(",r.shimArgs.join(","),"){"].join(""));for(var o=[],t=[],i=[["array",r.arrayArgs[0],".shape.slice(",Math.max(0,r.arrayBlockIndices[0]),r.arrayBlockIndices[0]<0?","+r.arrayBlockIndices[0]+")":")"].join("")],h=[],p=[],c=0;c<r.arrayArgs.length;++c){var u=r.arrayArgs[c];s.push(["t",u,"=array",u,".dtype,","r",u,"=array",u,".order"].join("")),o.push("t"+u),o.push("r"+u),t.push("t"+u),t.push("r"+u+".join()"),i.push("array"+u+".data"),i.push("array"+u+".stride"),i.push("array"+u+".offset|0"),c>0&&(h.push("array"+r.arrayArgs[0]+".shape.length===array"+u+".shape.length+"+(Math.abs(r.arrayBlockIndices[0])-Math.abs(r.arrayBlockIndices[c]))),p.push("array"+r.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[0])+"]===array"+u+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[c])+"]"))}for(r.arrayArgs.length>1&&(e.push("if (!("+h.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+r.arrayArgs[0]+".shape.length-"+Math.abs(r.arrayBlockIndices[0])+"; shapeIndex--\x3e0;) {"),e.push("if (!("+p.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}")),c=0;c<r.scalarArgs.length;++c)i.push("scalar"+r.scalarArgs[c]);return s.push(["type=[",t.join(","),"].join()"].join("")),s.push("proc=CACHED[type]"),e.push("var "+s.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",o.join(","),"])}","return proc(",i.join(","),")}"].join("")),r.debug&&console.log("-----Generated thunk:\n"+e.join("\n")+"\n----------"),new Function("compile",e.join("\n"))(a.bind(void 0,r))}(e)}export{o as default};